<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StorySpark</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind 'slate-50' */
        }

        /* Subtle Ken Burns effect for the slide image */
        @keyframes kenburns {
            0% {
                transform: scale(1) translate(0, 0);
            }
            100% {
                transform: scale(1.08) translate(-2%, 1%);
            }
        }
        .kenburns {
            animation: kenburns 25s ease-in-out infinite alternate;
        }

        /* Gentle pulse/glow for primary action buttons */
        @keyframes pulse-glow {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 8px rgba(59, 130, 246, 0); /* blue-500 */
            }
            50% {
                opacity: 0.95;
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            }
        }
        .pulse-glow {
            animation: pulse-glow 2.5s ease-in-out infinite;
        }

        /* Hide scrollbars for the reader view */
        .reader-view-no-scroll {
            overflow: hidden;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'spark-blue': {
                            light: '#e0f2fe', // sky-100
                            DEFAULT: '#a8d8ea', // Custom
                            dark: '#0ea5e9', // sky-500
                        },
                        'spark-green': {
                            light: '#d1fae5', // emerald-100
                            DEFAULT: '#a8e6cf', // Custom
                            dark: '#10b981', // emerald-500
                        },
                        'spark-yellow': {
                            light: '#fef3c7', // amber-100
                            DEFAULT: '#ffd3b6', // Custom
                            dark: '#f59e0b', // amber-500
                        },
                        'spark-text': '#334155', // slate-700
                    },
                }
            }
        }
    </script>
</head>
<body class="antialiased text-spark-text">

    <div id="app-container" class="min-h-screen">

        <div id="loading-view" class="fixed inset-0 flex items-center justify-center bg-slate-50 z-50">
            <svg class="animate-spin h-10 w-10 text-spark-blue-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>

        <div id="login-view" class="hidden min-h-screen flex items-center justify-center bg-spark-blue-light p-4">
            <div class="bg-white p-8 md:p-12 rounded-2xl shadow-xl text-center max-w-md w-full">
                <h1 class="text-5xl font-bold text-spark-blue-dark mb-3">StorySpark</h1>
                <p class="text-lg text-slate-600 mb-10">A calm, focused reader for your child.</p>
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-full font-semibold text-lg shadow-lg flex items-center justify-center gap-3 transition-all transform hover:scale-105">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691c-1.229 2.254-1.956 4.819-1.956 7.615c0 2.796.727 5.361 1.956 7.615l-5.657 5.657C.638 32.713 0 28.5 0 24c0-4.5.638-8.713 2.649-12.319l5.657 2.999z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-5.657-5.657C30.01 35.156 27.208 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-5.657 5.657C9.86 42.023 16.44 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l5.657 5.657C39.998 36.43 44 30.8 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    Sign In with Google
                </button>
            </div>
        </div>

        <div id="home-view" class="hidden min-h-screen bg-slate-50">
            <header class="bg-white shadow-sm sticky top-0 z-10">
                <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-20">
                        <div class="flex-shrink-0 flex items-center">
                            <h1 class="text-3xl font-bold text-spark-blue-dark">StorySpark</h1>
                        </div>
                        <div class="flex items-center gap-4">
                            <span id="user-name" class="text-slate-600 hidden md:block"></span>
                            <button id="admin-link" class="hidden bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded-full font-semibold text-sm transition-all">Teacher's Desk</button>
                            <button id="logout-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 py-2 px-4 rounded-full font-semibold text-sm transition-all">Logout</button>
                        </div>
                    </div>
                </nav>
            </header>

            <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                <h2 class="text-3xl font-semibold text-spark-text mb-6">Your Bookshelf</h2>
                <div id="bookshelf-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                    </div>
            </main>
        </div>

        <div id="reader-view" class="hidden fixed inset-0 bg-spark-blue-light z-20 flex flex-col p-4 md:p-8 transition-opacity duration-500 opacity-0">
            
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <button id="reader-home-btn" class="bg-white/70 backdrop-blur-sm hover:bg-white text-spark-text p-3 rounded-full shadow-md transition-all transform hover:scale-110">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>
                </button>
            </div>

            <div class="flex-grow flex flex-col items-center justify-center overflow-hidden">
                <div id="slide-image-container" class="w-full max-w-4xl aspect-video bg-gray-200 rounded-2xl shadow-xl overflow-hidden mb-6 transition-opacity duration-300">
                    <img id="slide-image" src="" alt="Story slide" class="w-full h-full object-cover">
                </div>

                <div id="slide-text-container" class="w-full max-w-4xl transition-opacity duration-300">
                    <p id="slide-text" class="text-3xl md:text-5xl font-semibold text-spark-text text-center p-6 bg-white/70 backdrop-blur-sm rounded-2xl shadow-lg">
                        Loading...
                    </p>
                </div>
            </div>

            <div class="flex-shrink-0 flex items-center justify-center gap-6 md:gap-12 p-6">
                <button id="prev-slide-btn" class="bg-white text-spark-blue-dark p-4 rounded-full shadow-lg transition-all transform hover:scale-110 disabled:opacity-30 disabled:cursor-not-allowed">
                    <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                </button>
                <button id="speak-btn" class="bg-spark-green-dark text-white p-6 rounded-full shadow-xl transition-all transform hover:scale-110 pulse-glow">
                    <svg class="w-10 h-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.38a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                </button>
                <button id="next-slide-btn" class="bg-white text-spark-blue-dark p-4 rounded-full shadow-lg transition-all transform hover:scale-110 disabled:opacity-30 disabled:cursor-not-allowed pulse-glow">
                    <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                </button>
            </div>
        </div>

        <div id="admin-view" class="hidden min-h-screen bg-slate-100 p-4 sm:p-6 lg:p-8">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-semibold text-spark-text">Teacher's Desk</h2>
                    <button id="admin-home-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 py-2 px-4 rounded-full font-semibold text-sm transition-all">Back to Bookshelf</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Create New Book</h3>
                        <form id="create-book-form" class="space-y-4">
                            <div>
                                <label for="book-title" class="block text-sm font-medium text-slate-700">Book Title</label>
                                <input type="text" id="book-title" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-spark-blue-dark focus:border-spark-blue-dark sm:text-sm">
                            </div>
                            <div>
                                <label for="book-cover" class="block text-sm font-medium text-slate-700">Cover Image URL</label>
                                <input type="url" id="book-cover" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-spark-blue-dark focus:border-spark-blue-dark sm:text-sm">
                            </div>
                            <button type="submit" class="w-full bg-spark-blue-dark hover:bg-sky-600 text-white py-2 px-4 rounded-md font-semibold transition-all">Create Book</button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Add/Manage Slides</h3>
                        
                        <div>
                            <label for="admin-book-select" class="block text-sm font-medium text-slate-700">Select Book</label>
                            <select id="admin-book-select" class="mt-1 block w-full px-3 py-2 border border-slate-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-spark-blue-dark focus:border-spark-blue-dark sm:text-sm">
                                <option value="">-- Please select a book --</option>
                                </select>
                        </div>
                        
                        <div id="admin-slide-list-container" class="mt-4 hidden">
                            <h4 class="text-lg font-semibold mb-2">Current Slides</h4>
                            <ul id="admin-slide-list" class="max-h-40 overflow-y-auto space-y-2 text-sm bg-slate-50 p-3 rounded-md">
                                </ul>
                        </div>

                        <form id="add-slide-form" class="space-y-4 mt-6">
                            <input type="hidden" id="admin-selected-book-id">
                            <div>
                                <label for="slide-image-url" class="block text-sm font-medium text-slate-700">Slide Image URL</label>
                                <input type="url" id="slide-image-url" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-spark-blue-dark focus:border-spark-blue-dark sm:text-sm">
                            </div>
                            <div>
                                <label for="slide-text-content" class="block text-sm font-medium text-slate-700">Text for Speech (single sentence)</label>
                                <textarea id="slide-text-content" rows="3" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-spark-blue-dark focus:border-spark-blue-dark sm:text-sm"></textarea>
                            </div>
                            <div>
                                <label for="slide-order" class="block text-sm font-medium text-slate-700">Order</label>
                                <input type="number" id="slide-order" min="1" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-spark-blue-dark focus:border-spark-blue-dark sm:text-sm">
                            </div>
                            <button type="submit" class="w-full bg-spark-green-dark hover:bg-emerald-600 text-white py-2 px-4 rounded-md font-semibold transition-all">Add Slide</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Import Firebase (compat)
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js');
        const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js');
        const { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js');

        // === Global State ===
        let app, auth, db;
        let appId;
        let currentUserId, currentUserEmail, isTeacher = false;
        let currentBookId, currentSlides = [], currentSlideIndex = 0;
        let ttsUtterance, speechVoices = [];
        let unsubscribeBooks = () => {};
        let unsubscribeSlides = () => {};
        let unsubscribeUserRole = () => {};
        let unsubscribeAdminBooks = () => {};
        let unsubscribeAdminSlides = () => {};

        // === DOM Element References ===
        const loadingView = document.getElementById('loading-view');
        const loginView = document.getElementById('login-view');
        const homeView = document.getElementById('home-view');
        const readerView = document.getElementById('reader-view');
        const adminView = document.getElementById('admin-view');

        // Auth
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userName = document.getElementById('user-name');
        const adminLink = document.getElementById('admin-link');
        
        // Home
        const bookshelfGrid = document.getElementById('bookshelf-grid');

        // Reader
        const readerHomeBtn = document.getElementById('reader-home-btn');
        const slideImageContainer = document.getElementById('slide-image-container');
        const slideImage = document.getElementById('slide-image');
        const slideTextContainer = document.getElementById('slide-text-container');
        const slideText = document.getElementById('slide-text');
        const prevSlideBtn = document.getElementById('prev-slide-btn');
        const nextSlideBtn = document.getElementById('next-slide-btn');
        const speakBtn = document.getElementById('speak-btn');

        // Admin
        const adminHomeBtn = document.getElementById('admin-home-btn');
        const createBookForm = document.getElementById('create-book-form');
        const addSlideForm = document.getElementById('add-slide-form');
        const adminBookSelect = document.getElementById('admin-book-select');
        const adminSlideListContainer = document.getElementById('admin-slide-list-container');
        const adminSlideList = document.getElementById('admin-slide-list');

        // === Helper Functions ===

        /**
         * Shows the specified view and hides all others.
         * @param {string} viewId - The ID of the view to show ('login-view', 'home-view', etc.)
         */
        function showView(viewId) {
            [loginView, homeView, readerView, adminView, loadingView].forEach(view => {
                view.classList.add('hidden');
            });

            // Handle special case for reader view fade-in
            if (viewId === 'reader-view') {
                const view = document.getElementById(viewId);
                view.classList.remove('hidden');
                document.body.classList.add('reader-view-no-scroll');
                // Use setTimeout to allow the 'hidden' class to be removed before adding opacity
                setTimeout(() => view.classList.add('opacity-100'), 50);
            } else if (viewId) {
                document.body.classList.remove('reader-view-no-scroll');
                document.getElementById(viewId).classList.remove('hidden');
            }
        }

        /**
         * Unsubscribes from all active Firestore listeners.
         */
        function unsubscribeAll() {
            unsubscribeBooks();
            unsubscribeSlides();
            unsubscribeUserRole();
            unsubscribeAdminBooks();
            unsubscribeAdminSlides();
        }

        // === Text-to-Speech (TTS) Logic ===

        /**
         * Initializes the Text-to-Speech engine and selects a voice.
         */
        function initTTS() {
            if (!'speechSynthesis' in window) {
                console.warn('Speech Synthesis not supported.');
                speakBtn.disabled = true;
                return;
            }

            ttsUtterance = new SpeechSynthesisUtterance();
            ttsUtterance.rate = 0.8; // Slower pace
            ttsUtterance.pitch = 1.0;
            ttsUtterance.lang = 'en-US';

            // Function to load and select a voice
            const loadVoices = () => {
                speechVoices = window.speechSynthesis.getVoices();
                // Try to find a high-quality voice
                let preferredVoice = 
                    speechVoices.find(v => v.name === 'Google US English' && v.lang.startsWith('en')) ||
                    speechVoices.find(v => v.name === 'Samantha' && v.lang.startsWith('en')) ||
                    speechVoices.find(v => v.lang === 'en-US' && v.localService) ||
                    speechVoices.find(v => v.lang === 'en-US');

                if (preferredVoice) {
                    ttsUtterance.voice = preferredVoice;
                }
            };

            // Voices are loaded asynchronously
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices(); // Call once in case they are already loaded
        }

        /**
         * Speaks the provided text using the browser's TTS.
         * @param {string} text - The text to speak.
         */
        function speakText(text) {
            if (!'speechSynthesis' in window || !ttsUtterance) return;
            window.speechSynthesis.cancel(); // Stop any previous speech
            ttsUtterance.text = text;
            window.speechSynthesis.speak(ttsUtterance);
        }

        // === Authentication Logic ===

        /**
         * Sets up the auth state listener to react to sign-in/sign-out.
         */
        function handleAuthState() {
            onAuthStateChanged(auth, async (user) => {
                unsubscribeAll(); // Clean up old listeners
                if (user) {
                    // User is signed in
                    currentUserId = user.uid;
                    currentUserEmail = user.email;
                    userName.textContent = `Welcome, ${user.displayName || user.email}`;
                    userName.classList.remove('hidden');

                    // Check for teacher role
                    await checkUserRole(user.uid);
                    
                    // Load bookshelf
                    loadBooks();
                    
                    showView('home-view');
                } else {
                    // User is signed out
                    currentUserId = null;
                    currentUserEmail = null;
                    isTeacher = false;
                    userName.classList.add('hidden');
                    adminLink.classList.add('hidden');
                    
                    showView('login-view');
                }
            });
        }

        /**
         * Initiates the Google Sign-In popup flow.
         */
        async function signIn() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Create/update user document in Firestore
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
                await setDoc(userDocRef, {
                    email: user.email,
                    displayName: user.displayName,
                    lastLogin: serverTimestamp()
                }, { merge: true }); // Use merge to avoid overwriting role

            } catch (error) {
                console.error("Error during sign in:", error);
            }
        }

        /**
         * Signs the current user out.
         */
        function logOut() {
            signOut(auth).catch(error => console.error("Error signing out:", error));
        }

        /**
         * Listens for changes to the user's role document.
         * @param {string} uid - The user's ID.
         */
        async function checkUserRole(uid) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${uid}`);
            
            // Listen for real-time role changes
            unsubscribeUserRole = onSnapshot(userDocRef, (doc) => {
                if (doc.exists() && doc.data().role === 'teacher') {
                    isTeacher = true;
                    adminLink.classList.remove('hidden');
                    loadBooksForAdmin(); // Load books into admin panel
                } else {
                    isTeacher = false;
                    adminLink.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error checking user role:", error);
            });
        }

        // === Home View (Bookshelf) Logic ===

        /**
         * Fetches and displays the list of books on the bookshelf.
         */
        function loadBooks() {
            const booksCol = collection(db, `artifacts/${appId}/public/data/books`);
            const q = query(booksCol, orderBy('title'));

            unsubscribeBooks = onSnapshot(q, (snapshot) => {
                bookshelfGrid.innerHTML = ''; // Clear existing books
                if (snapshot.empty) {
                    bookshelfGrid.innerHTML = '<p class="text-slate-500 col-span-full">No books found. A teacher can add some!</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const book = doc.data();
                    const bookId = doc.id;
                    
                    const bookEl = document.createElement('div');
                    bookEl.className = 'bg-white rounded-lg shadow-md overflow-hidden cursor-pointer transition-all transform hover:shadow-xl hover:-translate-y-1';
                    bookEl.innerHTML = `
                        <img src="${book.coverImageUrl}" alt="${book.title} cover" class="w-full h-48 sm:h-64 object-cover bg-gray-200">
                        <div class="p-4">
                            <h3 class="text-lg font-semibold text-spark-text truncate">${book.title}</h3>
                        </div>
                    `;
                    bookEl.onclick = () => openReader(bookId);
                    bookshelfGrid.appendChild(bookEl);
                });

            }, (error) => {
                console.error("Error loading books:", error);
                bookshelfGrid.innerHTML = '<p class="text-red-500 col-span-full">Could not load books.</p>';
            });
        }

        // === Reader View (Slideshow) Logic ===

        /**
         * Opens the reader view for a specific book.
         * @param {string} bookId - The ID of the book to open.
         */
        function openReader(bookId) {
            currentBookId = bookId;
            currentSlideIndex = 0;
            currentSlides = [];

            // Reset view to loading state
            slideImage.src = "";
            slideText.textContent = "Loading...";
            prevSlideBtn.disabled = true;
            nextSlideBtn.disabled = true;
            slideImage.classList.remove('kenburns'); // Stop animation
            showView('reader-view');

            const slidesCol = collection(db, `artifacts/${appId}/public/data/books/${bookId}/slides`);
            const q = query(slidesCol, orderBy('order'));

            unsubscribeSlides = onSnapshot(q, (snapshot) => {
                currentSlides = []; // Reset slides array on update
                snapshot.forEach((doc) => {
                    currentSlides.push({ id: doc.id, ...doc.data() });
                });

                if (currentSlides.length > 0) {
                    displaySlide();
                } else {
                    slideText.textContent = "This book has no slides yet.";
                    slideImage.src = ""; // Clear image
                }
            }, (error) => {
                console.error("Error loading slides:", error);
                slideText.textContent = "Could not load slides.";
            });
        }

        /**
         * Displays the current slide based on `currentSlideIndex`.
         */
        function displaySlide() {
            if (currentSlides.length === 0) return;

            const slide = currentSlides[currentSlideIndex];
            
            // --- Apply fade-out/fade-in transition ---
            slideImageContainer.classList.add('opacity-0');
            slideTextContainer.classList.add('opacity-0');
            
            // Stop TTS if it's playing from the previous slide
            window.speechSynthesis.cancel();

            // After a short delay (for fade-out), update content and fade-in
            setTimeout(() => {
                // Update content
                slideImage.src = slide.imageUrl;
                slideText.textContent = slide.text;

                // Restart Ken Burns animation
                slideImage.classList.remove('kenburns');
                void slideImage.offsetWidth; // Trigger a DOM reflow
                slideImage.classList.add('kenburns');
                
                // Update button states
                prevSlideBtn.disabled = (currentSlideIndex === 0);
                nextSlideBtn.disabled = (currentSlideIndex === currentSlides.length - 1);

                prevSlideBtn.classList.toggle('opacity-30', prevSlideBtn.disabled);
                prevSlideBtn.classList.toggle('cursor-not-allowed', prevSlideBtn.disabled);
                nextSlideBtn.classList.toggle('opacity-30', nextSlideBtn.disabled);
                nextSlideBtn.classList.toggle('cursor-not-allowed', nextSlideBtn.disabled);

                // Fade in
                slideImageContainer.classList.remove('opacity-0');
                slideTextContainer.classList.remove('opacity-0');

            }, 300); // 300ms matches the transition duration
        }

        /**
         * Changes the current slide.
         * @param {number} direction - 1 for next, -1 for previous.
         */
        function changeSlide(direction) {
            const newIndex = currentSlideIndex + direction;
            if (newIndex >= 0 && newIndex < currentSlides.length) {
                currentSlideIndex = newIndex;
                displaySlide();
            }
        }

        /**
         * Closes the reader and returns to the home view.
         */
        function goHome() {
            showView('home-view');
            window.speechSynthesis.cancel(); // Stop any active speech
            unsubscribeSlides(); // Stop listening for slide updates
            currentBookId = null;
            currentSlides = [];
            // Remove opacity class from reader for next time
            readerView.classList.remove('opacity-100'); 
        }

        // === Admin View Logic ===

        /**
         * Loads all books into the admin panel's select dropdown.
         */
        function loadBooksForAdmin() {
            const booksCol = collection(db, `artifacts/${appId}/public/data/books`);
            const q = query(booksCol, orderBy('title'));

            unsubscribeAdminBooks = onSnapshot(q, (snapshot) => {
                let currentVal = adminBookSelect.value;
                adminBookSelect.innerHTML = '<option value="">-- Please select a book --</option>';
                snapshot.forEach((doc) => {
                    const book = doc.data();
                    adminBookSelect.innerHTML += `<option value="${doc.id}">${book.title}</option>`;
                });
                // Preserve selection if possible
                if (currentVal) {
                    adminBookSelect.value = currentVal;
                }
            }, (error) => {
                console.error("Error loading books for admin:", error);
            });
        }

        /**
         * Loads the slides for the selected book in the admin panel.
         */
        function loadSlidesForAdmin() {
            const bookId = adminBookSelect.value;
            unsubscribeAdminSlides(); // Unsubscribe from previous book's slides
            
            if (!bookId) {
                adminSlideListContainer.classList.add('hidden');
                document.getElementById('admin-selected-book-id').value = '';
                return;
            }

            document.getElementById('admin-selected-book-id').value = bookId;
            adminSlideListContainer.classList.remove('hidden');
            
            const slidesCol = collection(db, `artifacts/${appId}/public/data/books/${bookId}/slides`);
            const q = query(slidesCol, orderBy('order'));

            unsubscribeAdminSlides = onSnapshot(q, (snapshot) => {
                adminSlideList.innerHTML = '';
                if (snapshot.empty) {
                    adminSlideList.innerHTML = '<li class="text-slate-500">No slides for this book yet.</li>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const slide = doc.data();
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-white p-2 rounded';
                    li.innerHTML = `
                        <span><strong>${slide.order}:</strong> ${slide.text.substring(0, 30)}...</span>
                        <button data-id="${doc.id}" class="delete-slide-btn text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                    `;
                    adminSlideList.appendChild(li);
                });
            }, (error) => {
                console.error("Error loading slides for admin:", error);
                adminSlideList.innerHTML = '<li class="text-red-500">Could not load slides.</li>';
            });
        }

        /**
         * Handles the "Create New Book" form submission.
         */
        async function handleCreateBook(e) {
            e.preventDefault();
            const title = document.getElementById('book-title').value;
            const coverImageUrl = document.getElementById('book-cover').value;
            
            try {
                const booksCol = collection(db, `artifacts/${appId}/public/data/books`);
                await addDoc(booksCol, {
                    title,
                    coverImageUrl,
                    createdBy: currentUserEmail,
                    createdAt: serverTimestamp()
                });
                createBookForm.reset();
            } catch (error) {
                console.error("Error creating book:", error);
                // Here you could show a non-alert error message
            }
        }

        /**
         * Handles the "Add Slide" form submission.
         */
        async function handleAddSlide(e) {
            e.preventDefault();
            const bookId = document.getElementById('admin-selected-book-id').value;
            const imageUrl = document.getElementById('slide-image-url').value;
            const text = document.getElementById('slide-text-content').value;
            const order = parseInt(document.getElementById('slide-order').value);

            if (!bookId) {
                console.warn("No book selected to add slide to."); // Show user-facing error
                return;
            }
            if (isNaN(order) || order <= 0) {
                console.warn("Order must be a positive number."); // Show user-facing error
                return;
            }

            try {
                const slidesCol = collection(db, `artifacts/${appId}/public/data/books/${bookId}/slides`);
                await addDoc(slidesCol, {
                    imageUrl,
                    text,
                    order
                });
                addSlideForm.reset();
                // Manually reset book ID as it's hidden
                document.getElementById('admin-selected-book-id').value = bookId;
            } catch (error) {
                console.error("Error adding slide:", error);
            }
        }

        /**
         * Handles deleting a slide from the admin panel.
         */
        async function handleDeleteSlide(e) {
            if (!e.target.classList.contains('delete-slide-btn')) return;

            const slideId = e.target.dataset.id;
            const bookId = adminBookSelect.value;
            
            if (!bookId || !slideId) return;

            // Using confirm for simplicity, replace with a modal div in production
            if (confirm("Are you sure you want to delete this slide?")) {
                try {
                    const slideDocRef = doc(db, `artifacts/${appId}/public/data/books/${bookId}/slides/${slideId}`);
                    await deleteDoc(slideDocRef);
                } catch (error) {
                    console.error("Error deleting slide:", error);
                }
            }
        }

        // === App Initialization ===

        /**
         * Main function to initialize the application.
         */
        function init() {
            // Check for placeholder Firebase config
            if (typeof __firebase_config === 'undefined' || typeof __app_id === 'undefined') {
                document.body.innerHTML = `
                    <div class="p-8 bg-red-100 text-red-800">
                        <strong>Error:</strong> Firebase configuration variables (<code>__app_id</code>, <code>__firebase_config</code>) are not defined.
                        Please define them in the global scope before this script.
                    </div>`;
                return;
            }
            
            appId = __app_id;
            
            // Initialize Firebase
            app = initializeApp(__firebase_config);
            auth = getAuth(app);
            db = getFirestore(app);

            // Initialize TTS
            initTTS();

            // Setup Event Listeners
            loginBtn.onclick = signIn;
            logoutBtn.onclick = logOut;
            adminLink.onclick = () => showView('admin-view');
            adminHomeBtn.onclick = goHome;
            readerHomeBtn.onclick = goHome;
            
            speakBtn.onclick = () => speakText(currentSlides[currentSlideIndex].text);
            nextSlideBtn.onclick = () => changeSlide(1);
            prevSlideBtn.onclick = () => changeSlide(-1);

            createBookForm.onsubmit = handleCreateBook;
            addSlideForm.onsubmit = handleAddSlide;
            adminBookSelect.onchange = loadSlidesForAdmin;
            adminSlideList.onclick = handleDeleteSlide; // Event delegation for delete buttons

            // Start auth listener
            handleAuthState();
        }

        // Start the app once the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>